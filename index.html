<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
</head>
<body>
  <label for="service">Service:</label>
  <input type="text" id="service">
  <br>
  <label for="characteristic">Characteristic:</label>
  <input type="text" id="characteristic">
  <br>
  <button onclick="connectButtonShowServices()">Connect Show Services</button>
  <button onclick="connectServiceAndCharacteristic()">Connect Service and Characteristic</button>
  <button onclick="connectButton()">Connect</button>
  <button onclick="connectAntPrintTestButton()">Connect and print and disconnect</button>
  <button onclick="connectAntPrintTestButtonDeprecated()">Connect and print and disconnect deprecated</button>
  <br>
  <label for="text">text:</label>
  <textarea style="width: 100%" rows="20" id="text"></textarea>
  <br>
  <button onclick="writeButtonNOutf()">Write TEXT NO utf8</button>
  <button onclick="writeButton()">Write TEXT</button>
  <button onclick="writeButtonSinEncode()">Write TEXT sin encode</button>
  <button onclick="writeButtonBuffer()">Write TEXT buffer</button>
  <button onclick="writeTestButton()">Write Test</button>
  <br>
  <textarea style="width: 100%" id="log" rows="20" readonly></textarea>
  <br>
  <button onclick="disconnect()">Disconnect</button>
</body>
<script>

function log(data) {
  document.querySelector('#log').textContent += data + '\n';
}
function clearLog() {
  document.querySelector('#log').textContent = '';
}

var device;
var channel;

async function connectButton() {
  clearLog();
  let serviceUuid = document.querySelector('#service').value;
  log('serviceUuid: ' + serviceUuid);

  let characteristicUuid = document.querySelector('#characteristic').value;
  log('characteristicUuid: ' + characteristicUuid);

  try {
    log('Requesting any Bluetooth Device...');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });

    log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    log('Getting Characteristic...');
    channel = await service.getCharacteristic(characteristicUuid);
    log(channel.properties);
    log('OK...');

  } catch(error) {
    log('Argh! ' + error);
  }
}

async function connectButtonShowServices() {
  clearLog();
  // let serviceUuid = document.querySelector('#service').value;
  // log('serviceUuid: ' + serviceUuid);

  // let characteristicUuid = document.querySelector('#characteristic').value;
  // log('characteristicUuid: ' + characteristicUuid);

  try {
    log('Requesting any Bluetooth Device...');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      // optionalServices: optionalServices
    });
    log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    log('Getting Services...');
    const services = await server.getPrimaryServices();

    log('Getting Characteristics...');
    for (const service of services) {
      log('> Service: ' + service.uuid);
      const characteristics = await service.getCharacteristics();
      characteristics.forEach(characteristic => {
        log('>> Characteristic: ' + characteristic.uuid);
        if (characteristic.properties.write) {
          log('>> Characteristic: ' + characteristic.uuid + ' (WRITE)');
        }
        if (characteristic.properties.writeWithoutResponse) {
          log('>> Characteristic: ' + characteristic.uuid + ' (WRITE WITHOUT RESPONSE)');
        }
        log('')
      });
    }
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function connectServiceAndCharacteristic() {
  let serviceUuid = document.querySelector('#service').value;
  log('serviceUuid: ' + serviceUuid);

  let characteristicUuid = document.querySelector('#characteristic').value;
  log('characteristicUuid: ' + characteristicUuid);

  try {
    log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    log('Getting Characteristic...');
    channel = await service.getCharacteristic(characteristicUuid);
    log('OK...');

  } catch(error) {
    log('Argh! ' + error);
  }
}

async function connectAntPrintTestButton() {
  clearLog();
  let serviceUuid = document.querySelector('#service').value;
  log('serviceUuid: ' + serviceUuid);

  let characteristicUuid = document.querySelector('#characteristic').value;
  log('characteristicUuid: ' + characteristicUuid);

  try {
    log('Requesting any Bluetooth Device...');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });

    log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    log('Getting Characteristic...');
    channel = await service.getCharacteristic(characteristicUuid);
    log(channel.properties);
    log('OK...');

    var DATA = ''
    + '\x1B' + '\x61' + '\x31'                                              // center align
    + '\x1D' + '\x21' + '\x11' + 'Hello\nBluetooth!\n\n'                    // double font size
    + '\x1D' + '\x21' + '\x00' + '... from your friends\nat https://qz.io'  // normal font size
    + '\n\n\n\n\n\n\n';                                                     // feed paper
    log('Writing test...')
    let writeOutput = await channel.writeValueWithoutResponse(new TextEncoder("utf-8").encode(DATA));
    log('OK...');
    log(writeOutput);
    device.gatt.disconnect();

  } catch(error) {
    log('Argh! ' + error);
  }
}


async function connectAntPrintTestButtonDeprecated() {
  clearLog();
  let serviceUuid = document.querySelector('#service').value;
  log('serviceUuid: ' + serviceUuid);

  let characteristicUuid = document.querySelector('#characteristic').value;
  log('characteristicUuid: ' + characteristicUuid);

  try {
    log('Requesting any Bluetooth Device...');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });

    log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    log('Getting Characteristic...');
    channel = await service.getCharacteristic(characteristicUuid);
    log(channel.properties);
    log('OK...');

    var DATA = ''
    + '\x1B' + '\x61' + '\x31'                                              // center align
    + '\x1D' + '\x21' + '\x11' + 'Hello\nBluetooth!\n\n'                    // double font size
    + '\x1D' + '\x21' + '\x00' + '... from your friends\nat https://qz.io'  // normal font size
    + '\n\n\n\n\n\n\n';                                                     // feed paper
    log('Writing test...')
    let writeOutput = await channel.writeValue(new TextEncoder("utf-8").encode(DATA));
    log('OK...');
    log(writeOutput);
    device.gatt.disconnect();

  } catch(error) {
    log('Argh! ' + error);
  }
}


async function writeButton() {
  if (!device || !channel) {
    log('Device or GATT Channel not connected');
    return;
  }
  let text = document.querySelector('#text').value;
  log('Text: ' + text);
  try {
    const value = new TextEncoder("utf-8").encode(text);
    let writeOutput = await channel.writeValueWithoutResponse(value);
    log('OK...');
    log(writeOutput);
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function writeButtonNOutf() {
  if (!device || !channel) {
    log('Device or GATT Channel not connected');
    return;
  }
  let text = document.querySelector('#text').value;
  log('Text: ' + text);
  try {
    const value = new TextEncoder().encode(text);
    let writeOutput = await channel.writeValueWithoutResponse(value);
    log('OK...');
    log(writeOutput);
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function writeButtonBuffer() {
  if (!device || !channel) {
    log('Device or GATT Channel not connected');
    return;
  }
  let text = document.querySelector('#text').value;
  log('Text: ' + text);
  try {
    const value = new TextEncoder("utf-8").encode(text);
    let writeOutput = await channel.writeValueWithoutResponse(value.buffer);
    log('OK...');
    log(writeOutput);
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function writeButtonSinEncode() {
  if (!device || !channel) {
    log('Device or GATT Channel not connected');
    return;
  }
  let text = document.querySelector('#text').value;
  log('Text: ' + text);
  try {
    let writeOutput = await channel.writeValueWithoutResponse(text);
    log('OK...');
    log(writeOutput);
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function writeTestButton() {
  if (!device || !channel) {
    log('Device or GATT Channel not connected');
    return;
  }
  var DATA = ''
    + '\x1B' + '\x61' + '\x31'                                              // center align
    + '\x1D' + '\x21' + '\x11' + 'Hello\nBluetooth!\n\n'                    // double font size
    + '\x1D' + '\x21' + '\x00' + '... from your friends\nat https://qz.io'  // normal font size
    + '\n\n\n\n\n\n\n';                                                     // feed paper
  log('Writing test...')
  try {
    let writeOutput = await channel.writeValueWithoutResponse(new TextEncoder("utf-8").encode(DATA));
    log('OK...');
    log(writeOutput);
  } catch(error) {
    log('Argh! ' + error);
  }
}

function disconnect() {
  if (device) {
    log('Disconnecting from Bluetooth Device...');
    try {
      device.gatt.disconnect();
    } catch(error) {
      log('Argh! ' + error);
    }
  }
  device = null;
  channel = null;
}
</script>
</html>
