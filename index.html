<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
</head>
<body>
  <label for="service">Service:</label>
  <input type="text" id="service">
  <br>
  <label for="characteristic">Characteristic:</label>
  <input type="text" id="characteristic">
  <br>
  <button onclick="connectButton()">Connect</button>
  <br>
  <label for="text">text:</label>
  <input type="text" id="text">
  <button onclick="writeButton()">Write</button>
  <br>
  <textarea style="width: 100%" id="log" rows="20"></textarea>
  <br>
  <button onclick="disconnect()">Disconnect</button>
</body>
<script>

function log(data) {
  document.querySelector('#log').textContent += data + '\n';
}
function clearLog() {
  document.querySelector('#log').textContent = '';
}

var device;
var channel;

async function connectButton() {
  clearLog();
  let serviceUuid = document.querySelector('#service').value;
  log('serviceUuid: ' + serviceUuid);

  let characteristicUuid = document.querySelector('#characteristic').value;
  log('characteristicUuid: ' + characteristicUuid);

  try {
    log('Requesting any Bluetooth Device...');
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUuid]
    });

    log('Connecting to GATT Server...');
    const server = await device.gatt.connect();

    log('Getting Service...');
    const service = await server.getPrimaryService(serviceUuid);

    log('Getting Characteristic...');
    channel = await service.getCharacteristic(characteristicUuid);

  } catch(error) {
    log('Argh! ' + error);
  }
}

async function writeButton() {
  if (!device || !channel) {
    log('Device or GATT Channel not connected');
    return;
  }
  let text = document.querySelector('#text').value;
  log('Text: ' + text);
  try {
    await channel.writeValue(new TextEncoder("utf-8").encode(text));
  } catch(error) {
    log('Argh! ' + error);
  }
}

function disconnect() {
  if (device) {
    log('Disconnecting from Bluetooth Device...');
    try {
      device.gatt.disconnect();
    } catch(error) {
      log('Argh! ' + error);
    }
  }
  device = null;
  channel = null;
}
</script>
</html>
